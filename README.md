# Проблемы компании

1. Когда нагрузка повышается, тогда сайт медленно загружает страницы
    - Нагрузка на поиск 50 RPC
    - Нагрузка на оформление страховки 10 RPS
2. Когда кратно вырастают запросы от одного партнера (250 против 20 RPS), тогда API медленно обрабатывает запросы
3. Когда падает приложение (убыток - 500 тыс. в час), тогда об этом узнаем от пользователей

# Система

Функции:
- Частным клиентам - оформить страховку (страхование жизни)
- Корпоративные клиенты - интегрируют страховку в свои продукты, оформляют страховку (страхование жизни)

# Архитектура

- core-app, backend по страховкам.
    - Функции: Показывает клиенту доступные продукты, оформляет заявки на новые страховки, отображает оформленные страховки.
    - Интеграция: Получает клиентские данные из client-info, проводит оплату страховки через платежный сервис, получает информацию по продуктам и тарифам из ins-product-aggregator
    - Состав: core-app, core-db
- client-info, backend по клиентским данным.
    - Функции: Хранит клиентские данные
    - Состав: client-info, ins-comp-settlement-db
- ins-product-aggregator
    - Функции: Выдает информацию по продуктам и тарифам страховых компаний
    - Интеграция: Получает информацию из систем страховых компаний
- ins-comp-settlement
    - Функции: Раз в месяц отправляет перечень оформленных страховок в страховые компании.
    - Состав: ins-comp-settlement, ins-comp-settlement-db
    - Интеграция: получает информацию о страховках из core-app, передает данные в системы страховых компаний (5 систем), получает информацию по продуктам и тарифам из ins-product-aggregator

Общее:
- Деплой через кластер Kubernetes, в одной зоне доступа
- Один экземпляр БД, разные схемы
- LoadBalancer Kubernetes реализует API для партрнеров

# Задание 1. Проектирвание технологической архитектуры

Геораспределение: Да
RTO (Recovery Time Objective): 45 минут, за это время мы должны восстановить систему
RPO (Recovery Point Objective): 15 минут, то есть можем потерять данные за последние 15 минут, а значит нужно иметь копию данных каждые 15 минут
Доступность: 99,9 %
Объем данных: 50 GB

## Схема

[Схема](./Exc1/InureTech_технологическая%20архитектура_to-be.xml)

## Стратегия масштабирования и отказоустойчивости

Приложение нужно деплоить в нескольких зонах безопасности, потому что по требованиям бизнеса необходима поддержка клиентов во всех часовых поясах. Сервисы масштабируем горизонтально, потому что сейчас они не выдерживают нагрузку и нагрузка будет расти. Базы данных пока не масштабируем, т.к. в них пока не наблюдается проблем, но повышаем их отказоустойчивсть и доступность с помощью Patroni.

## Конфигурация развертывания приложения в Kubernetes

Используем независимые кластеры, потому что это более управляемо и проще настраивается. Это решение более производительно, потому что каждый кластер использоует только свои ресурсы, а производительность является основной характеристикой для улучшения.

## Балансировка нагрузки

Балансировка нагрузки происходит через GSLB из-за присутствия двух ЦОД.

## Файловер-стратегия

Файловер стратегией выбрана active-active, т.к. у нас высокие требования к доступности и к RTO.

## Конфигурация базы данных

Совместно с Patroni будет реализовывавться бэкапирование через pgBackRest, чтобы удовлетворить требования по RPO.

## Шардирование БД

Шардирование не используется из-за небольшого количества данных.

# Задание 2. Динамическое масштабирование контейнеров

[events](./Exc2/events.png)
[pods](./Exc2/pods.png)

minikube start
kubectl apply -f deployment.yml
kubectl apply -f service.yml
kubectl apply -f hpa.yml
kubectl port-forward svc/scaletestapp-service 8080:80
http://localhost:8080


# Задание 3. Переход на Event-Driven архитектуру

[схема](./Exc3/InsureTech_C4_сontainer-diagram.drawio.xml)
[описание](./Exc3/description.md)


# Задание 4. Проектирование продажи ОСАГО

[схема](./Exc4/InsureTech_C4_сontainer-diagram.drawio.xml)

# Задание 5. Проектирование GraphQL API

[схема](./Exc5/api.gql)

# Задание 6. Настройка Rate Limiting

[конфиг](./Exc6/nginx.conf)












